
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Command Cooldown &#8212; Evennia 1.0-dev documentation</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Command Duration" href="Howto-Command-Duration.html" />
    <link rel="prev" title="Command Prompt" href="Howto-Command-Prompt.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Howto-Command-Duration.html" title="Command Duration"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="Howto-Command-Prompt.html" title="Command Prompt"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="Howtos-Overview.html" accesskey="U">Tutorials and Howto’s</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Command Cooldown</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>  

    <div class="document">

      <div class="documentwrapper">
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/evennia_logo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
<h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Command Cooldown</a><ul>
<li><a class="reference internal" href="#the-cooldown-contrib">The Cooldown Contrib</a></li>
<li><a class="reference internal" href="#non-persistent-cooldown">Non-persistent cooldown</a></li>
<li><a class="reference internal" href="#persistent-cooldown">Persistent cooldown</a></li>
<li><a class="reference internal" href="#make-a-cooldown-aware-command-parent">Make a cooldown-aware command parent</a><ul>
<li><a class="reference internal" href="#command-crossover">Command crossover</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="Howto-Command-Prompt.html"
                        title="previous chapter">Command Prompt</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="Howto-Command-Duration.html"
                        title="next chapter">Command Duration</a></p>
  <div role="note" aria-label="source link">
    <!--h3>This Page</h3-->
    <ul class="this-page-menu">
      <li><a href="../_sources/Howtos/Howto-Command-Cooldown.md.txt"
            rel="nofollow">Show Page Source</a></li>
    </ul>
   </div><h3>Links</h3>
<ul>
  <li><a href="https://www.evennia.com">Home page</a> </li>
  <li><a href="https://github.com/evennia/evennia">Evennia Github</a> </li>
  <li><a href="http://games.evennia.com">Game Index</a> </li>
  <li>
    <a href="https://discord.gg/AJJpcRUhtF">Discord</a> -
     <a href="https://github.com/evennia/evennia/discussions">Discussions</a> -
      <a href="https://evennia.blogspot.com/">Blog</a>
  </li>
</ul>
<h3>Versions</h3>
<ul>
  <li><a href="Howto-Command-Cooldown.html">1.0-dev (develop branch)</a></li>
 <ul>
  <li><a href="../0.9.5/index.html">0.9.5 (v0.9.5 branch)</a></li>

</ul>

        </div>
      </div>
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section class="tex2jax_ignore mathjax_ignore" id="command-cooldown">
<h1>Command Cooldown<a class="headerlink" href="#command-cooldown" title="Permalink to this headline">¶</a></h1>
<p>Some types of games want to limit how often a command can be run. If a
character casts the spell <em>Firestorm</em>, you might not want them to spam that
command over and over. Or in an advanced combat system, a massive swing may
offer a chance of lots of damage at the cost of not being able to re-do it for
a while. Such effects are called <em>cooldowns</em>.</p>
<p>This page exemplifies a very resource-efficient way to do cooldowns. A more
‘active’ way is to use asynchronous delays as in the <a class="reference internal" href="Howto-Command-Duration.html#blocking-commands"><span class="std std-doc">Blocking commands</span></a>, the two might be useful to
combine if you want to echo some message to the user after the cooldown ends.</p>
<section id="the-cooldown-contrib">
<h2>The Cooldown Contrib<a class="headerlink" href="#the-cooldown-contrib" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="../Contribs/Contrib-Cooldowns.html"><span class="doc std std-doc">Cooldown contrib</span></a> is a ready-made solution for
command cooldowns you can use. It implements a <em>handler</em> on the object to
conveniently manage and store the cooldowns in a similar manner exemplified in
this tutorial.</p>
</section>
<section id="non-persistent-cooldown">
<h2>Non-persistent cooldown<a class="headerlink" href="#non-persistent-cooldown" title="Permalink to this headline">¶</a></h2>
<p>This little recipe will limit how often a particular command can be run. Since
Commands are class instances, and those are cached in memory, a command
instance will remember things you store on it. So just store the current time
of execution! Next time the command is run, it just needs to check if it has
that time stored, and compare it with the current time to see if a desired
delay has passed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in, say, mygame/commands/spells.py</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">evennia</span> <span class="kn">import</span> <span class="n">default_cmds</span>

<span class="k">class</span> <span class="nc">CmdSpellFirestorm</span><span class="p">(</span><span class="n">default_cmds</span><span class="o">.</span><span class="n">MuxCommand</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Spell - Firestorm</span>

<span class="sd">    Usage:</span>
<span class="sd">      cast firestorm &lt;target&gt;</span>

<span class="sd">    This will unleash a storm of flame. You can only release one</span>
<span class="sd">    firestorm every five minutes (assuming you have the mana).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;cast firestorm&quot;</span>
    <span class="n">rate_of_fire</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># 2 minutes</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Implement the spell&quot;</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">last_cast</span> <span class="o">=</span> <span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">firestorm_last_cast</span>  <span class="c1"># could be None</span>
        <span class="k">if</span> <span class="n">last_cast</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_cast</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_of_fire</span><span class="p">):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;You cannot cast this spell again yet.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># [the spell effect is implemented]</span>

        <span class="c1"># if the spell was successfully cast, store the casting time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">ndb</span><span class="o">.</span><span class="n">firestorm_last_cast</span> <span class="o">=</span> <span class="n">now</span>
</pre></div>
</div>
<p>We specify <code class="docutils literal notranslate"><span class="pre">rate_of_fire</span></code> and then just check for a NAtrribute
<code class="docutils literal notranslate"><span class="pre">firestorm_last_cast</span></code> and update it if everything works out.</p>
<p>Simple and very effective since everything is just stored in memory. The
drawback of this simple scheme is that it’s non-persistent. If you do
<code class="docutils literal notranslate"><span class="pre">reload</span></code>, the cache is cleaned and all such ongoing cooldowns will be
forgotten.</p>
</section>
<section id="persistent-cooldown">
<h2>Persistent cooldown<a class="headerlink" href="#persistent-cooldown" title="Permalink to this headline">¶</a></h2>
<p>To make a cooldown <em>persistent</em> (so it survives a server reload), just
use the same technique, but use <a class="reference internal" href="../Components/Attributes.html"><span class="doc std std-doc">Attributes</span></a> (that is, <code class="docutils literal notranslate"><span class="pre">.db</span></code> instead
of <code class="docutils literal notranslate"><span class="pre">.ndb</span></code> storage to save the last-cast time.</p>
</section>
<section id="make-a-cooldown-aware-command-parent">
<h2>Make a cooldown-aware command parent<a class="headerlink" href="#make-a-cooldown-aware-command-parent" title="Permalink to this headline">¶</a></h2>
<p>If you have many different spells or other commands with cooldowns, you don’t
want to have to add this code every time. Instead you can make a “cooldown
command mixin” class. A <em>mixin</em> is a class that you can ‘add’ to another class
(via multiple inheritance) to give it some special ability. Here’s an example
with persistent storage:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in, for example, mygame/commands/mixins.py</span>

<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">CooldownCommandMixin</span><span class="p">:</span>

    <span class="n">rate_of_fire</span> <span class="o">=</span> <span class="mi">60</span>
    <span class="n">cooldown_storage_key</span> <span class="o">=</span> <span class="s2">&quot;last_used&quot;</span>
    <span class="n">cooldown_storage_category</span> <span class="o">=</span> <span class="s2">&quot;cmd_cooldowns&quot;</span>

    <span class="k">def</span> <span class="nf">check_cooldown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">last_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cooldown_storage_key</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cooldown_storage_category</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rate_of_fire</span>

    <span class="k">def</span> <span class="nf">update_cooldown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">attribute</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cooldown_storage_key</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">cooldown_storage_category</span>

        <span class="p">)</span>
</pre></div>
</div>
<p>This is meant to be mixed into a Command, so we assume <code class="docutils literal notranslate"><span class="pre">self.caller</span></code> exists.
We allow for setting what Attribute key/category to use to store the cooldown.</p>
<p>It also uses an Attribute-category to make sure what it stores is not mixed up
with other Attributes on the caller.</p>
<p>Here’s how it’s used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># in, say, mygame/commands/spells.py</span>

<span class="kn">from</span> <span class="nn">evennia</span> <span class="kn">import</span> <span class="n">default_cmds</span>
<span class="kn">from</span> <span class="nn">.mixins</span> <span class="kn">import</span> <span class="n">CooldownCommandMixin</span>


<span class="k">class</span> <span class="nc">CmdSpellFirestorm</span><span class="p">(</span>
        <span class="n">CooldownCommandMixin</span><span class="p">,</span> <span class="n">default_cmds</span><span class="o">.</span><span class="n">MuxCommand</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;cast firestorm&quot;</span>

    <span class="n">cooldown_storage_key</span> <span class="o">=</span> <span class="s2">&quot;firestorm_last_cast&quot;</span>
    <span class="n">rate_of_fire</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">2</span>

    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_cooldown</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">caller</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s2">&quot;You cannot cast this spell again yet.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># [the spell effect happens]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_cooldown</span><span class="p">()</span>

</pre></div>
</div>
<p>So the same as before, we have just hidden away the cooldown checks and you can
reuse this mixin for all your cooldowns.</p>
<section id="command-crossover">
<h3>Command crossover<a class="headerlink" href="#command-crossover" title="Permalink to this headline">¶</a></h3>
<p>This example of cooldown-checking also works <em>between</em> commands. For example,
you can have all fire-related spells store the cooldown with the same
<code class="docutils literal notranslate"><span class="pre">cooldown_storage_key</span></code> (like <code class="docutils literal notranslate"><span class="pre">fire_spell_last_used</span></code>). That would mean casting
of <em>Firestorm</em> would block all other fire-related spells for a while.</p>
<p>Similarly, when you take that that big sword swing, other types of attacks could
be blocked before you can recover your balance.</p>
</section>
</section>
</section>


          </div>
        </div>
      </div>

    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="Howto-Command-Duration.html" title="Command Duration"
             >next</a> |</li>
        <li class="right" >
          <a href="Howto-Command-Prompt.html" title="Command Prompt"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Evennia 1.0-dev</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="Howtos-Overview.html" >Tutorials and Howto’s</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Command Cooldown</a></li> 
      </ul>
        <div class="develop">develop branch</div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, The Evennia developer community.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>